#!/bin/bash
set -e

CONFIG_DIR="$HOME/.config/rclone-sync"
CACHE_DIR="$HOME/.cache/rclone/bisync"

# Check if any configs exist
if [ ! -d "$CONFIG_DIR" ] || [ -z "$(ls -A "$CONFIG_DIR" 2>/dev/null)" ]; then
    echo "No rclone-sync instances found."
    exit 0
fi

echo "This will delete ALL rclone-sync instances and their cache."
echo ""
echo "Instances to be deleted:"
for conf in "$CONFIG_DIR"/*.conf; do
    [ -f "$conf" ] || continue
    basename "$conf" .conf
done
echo ""
read -p "Are you sure? [y/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
fi

# Stop and disable all services, clean up cache
for conf in "$CONFIG_DIR"/*.conf; do
    [ -f "$conf" ] || continue
    INSTANCE=$(basename "$conf" .conf)
    
    echo "Removing: $INSTANCE"
    
    # Stop and disable service
    systemctl --user stop "rclone-sync@$INSTANCE" 2>/dev/null || true
    systemctl --user disable "rclone-sync@$INSTANCE" 2>/dev/null || true
    
    # Load config and clean cache
    source "$conf"
    if [ -n "$REMOTE_PATH" ] && [ -n "$LOCAL_DIR" ]; then
        SAFE_REMOTE=$(echo -n "$REMOTE_PATH" | base64 -w0 | tr '+/' '-_' | tr -d '=')
        SAFE_LOCAL=$(echo -n "$LOCAL_DIR" | base64 -w0 | tr '+/' '-_' | tr -d '=')
        PATTERN="$SAFE_REMOTE..$SAFE_LOCAL"
        find "$CACHE_DIR" -name "${PATTERN}*" -delete 2>/dev/null || true
    fi
done

# Remove all configs
rm -rf "$CONFIG_DIR"

echo ""
echo "All rclone-sync instances deleted."
