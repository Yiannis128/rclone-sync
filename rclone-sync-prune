#!/bin/bash
set -e

# Source common library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/rclone-sync-common.sh"

# Check if any configs exist
if [ ! -d "$CONFIG_DIR" ] || [ -z "$(ls -A "$CONFIG_DIR" 2>/dev/null)" ]; then
    echo "No rclone-sync instances found."
    exit 0
fi

echo "This will delete ALL rclone-sync instances and their cache."
echo ""
echo "Instances to be deleted:"
for conf in "$CONFIG_DIR"/*.conf; do
    [ -f "$conf" ] || continue
    basename "$conf" .conf
done
echo ""
read -p "Are you sure? [y/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
fi

# Stop and disable all services, clean up cache
for conf in "$CONFIG_DIR"/*.conf; do
    [ -f "$conf" ] || continue
    INSTANCE=$(basename "$conf" .conf)

    echo "Removing: $INSTANCE"

    # Stop and disable service
    stop_service "$INSTANCE"

    # Load config and clean cache
    source "$conf"
    cleanup_cache_files "$REMOTE_PATH" "$LOCAL_DIR"
done

# Remove all configs
rm -rf "$CONFIG_DIR"

echo ""
echo "All rclone-sync instances deleted."
