#!/bin/bash
set -e

# Source common library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/rclone-sync-common.sh"

usage() {
    echo "Usage: $0 [options] <instance-name> <remote-path> <local-dir>"
    echo "Options:"
    echo "  --max-delete N    Abort if >N files would be deleted (default: 50, 0=disable)"
    echo ""
    echo "Example: $0 documents gdrive:Documents ~/Documents"
    echo "Example: $0 --max-delete 100 photos gdrive:Photos ~/Photos"
    exit 1
}

MAX_DELETE=50

while [[ "$1" == --* ]]; do
    case "$1" in
        --max-delete)
            MAX_DELETE="$2"
            shift 2
            ;;
        *) echo "Invalid option: $1" >&2; usage ;;
    esac
done

if [ $# -ne 3 ]; then
    usage
fi

INSTANCE="$1"
REMOTE="$2"
LOCAL="$3"

# Expand ~ in local path
LOCAL=$(expand_path "$LOCAL")

CONFIG_FILE="$CONFIG_DIR/$INSTANCE.conf"

# Check if already exists
if [ -f "$CONFIG_FILE" ]; then
    echo "Error: Instance '$INSTANCE' already exists."
    echo "Use 'rclone-sync-delete $INSTANCE' first to remove it."
    exit 1
fi

# Create config directory
mkdir -p "$CONFIG_DIR"

# Create config file
cat > "$CONFIG_FILE" <<EOF
REMOTE_PATH="$REMOTE"
LOCAL_DIR="$LOCAL"
MAX_DELETE="$MAX_DELETE"
EOF

echo "Created config: $CONFIG_FILE"
echo ""
echo "Commands:"
echo "  Start:   systemctl --user start rclone-sync@$INSTANCE"
echo "  Enable:  systemctl --user enable rclone-sync@$INSTANCE"
echo "  Status:  systemctl --user status rclone-sync@$INSTANCE"
echo "  Logs:    journalctl --user -u rclone-sync@$INSTANCE -f"
echo ""
echo "To start and enable now:"
echo "  systemctl --user enable --now rclone-sync@$INSTANCE"
